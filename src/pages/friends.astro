---
import { siteConfig } from "../config";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";
// import type { FriendLink } from "../types/config";
---

<!-- 极验验证SDK -->
<script src="https://static.geetest.com/v4/gt4.js"></script>

<MainGridLayout title={i18n(I18nKey.friends)} description={i18n(I18nKey.friends)}>
  <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-500 rounded dark:bg-blue-900/30 dark:border-blue-400">
    <p class="text-blue-700 dark:text-blue-300">
      <i class="fas fa-info-circle mr-2"></i>
      友链列表通过 AJAX 动态加载，数据实时更新。
    </p>
  </div>
  
  <div id="friends-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- 友链将通过 JavaScript 动态加载 -->
    <div class="col-span-full text-center py-10">
      <div class="spinner"></div>
      <p class="mt-4 dark:text-white">加载中...</p>
    </div>
  </div>
  
  <div class="mt-10 card-base p-6">
    <h2 class="text-2xl font-bold mb-5 text-primary dark:text-white">{i18n(I18nKey.about)} {i18n(I18nKey.friends)}</h2>
    <div class="prose max-w-none">
      <p class="mb-4 text-lg dark:text-white">
        欢迎互换友链！如果您希望与本站互换友链，请通过以下方式联系我：
      </p>
      <ul class="list-disc pl-6 mb-5 space-y-2">
        <li class="dark:text-white"><strong class="dark:text-white">网站名称：</strong>{siteConfig.title}</li>
        <li class="dark:text-white"><strong class="dark:text-white">网站链接：</strong>{"https://blog.my0811.cn"}</li>
        <li class="dark:text-white"><strong class="dark:text-white">网站描述：</strong>{siteConfig.subtitle}</li>
        <li class="dark:text-white"><strong class="dark:text-white">网站图标：</strong>https://blog.my0811.cn/favicon.ico</li>
      </ul>
      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 dark:bg-blue-900/30 dark:border-blue-400">
        <p class="text-blue-700 dark:text-blue-300">
          <i class="fas fa-info-circle mr-2"></i>
          请确保您的网站内容健康、积极向上，且无违法违规内容。我会定期检查友链，对于失效或内容不当的链接会进行清理。
        </p>
      </div>
      <p class="text-gray-600 italic dark:text-gray-400">
        注意：添加友链前请先添加本站友链，添加后可联系我确认。
      </p>
    </div>
  </div>
  
  <!-- 友链申请表单 -->
  <div class="mt-10 card-base p-6" id="friendFormContainer">
    <h2 class="text-2xl font-bold mb-5 text-primary dark:text-white">申请友链</h2>
    <form id="friendForm" class="space-y-4">
      <div>
        <label for="siteName" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">网站名称 *</label>
        <input 
          type="text" 
          id="siteName" 
          name="siteName" 
          required 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-[var(--card-bg)] dark:border-gray-600 dark:text-white transition-colors"
          placeholder="请输入您的网站名称"
        />
      </div>
      
      <div>
        <label for="siteUrl" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">网站链接 *</label>
        <input 
          type="url" 
          id="siteUrl" 
          name="siteUrl" 
          required 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-[var(--card-bg)] dark:border-gray-600 dark:text-white transition-colors"
          placeholder="https://example.com"
        />
      </div>
      
      <div>
        <label for="siteDescription" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">网站描述</label>
        <input 
          type="text" 
          id="siteDescription" 
          name="siteDescription" 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-[var(--card-bg)] dark:border-gray-600 dark:text-white transition-colors"
          placeholder="请输入您的网站描述"
        />
      </div>
      
      <div>
        <label for="siteAvatar" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">网站图标</label>
        <input 
          type="url" 
          id="siteAvatar" 
          name="siteAvatar" 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-[var(--card-bg)] dark:border-gray-600 dark:text-white transition-colors"
          placeholder="https://example.com/avatar.jpg"
        />
      </div>
      
      <div>
        <label for="email" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">联系邮箱 *</label>
        <input 
          type="email" 
          id="email" 
          name="email" 
          required 
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-[var(--card-bg)] dark:border-gray-600 dark:text-white transition-colors"
          placeholder="your@email.com"
        />
      </div>
      
      <!-- 极验验证容器 -->
      <div id="captcha-container" class="mt-4"></div>
      
      <div>
        <button 
          type="submit" 
          id="submitBtn"
          class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:bg-blue-500 dark:hover:bg-blue-600 transition-colors"
        >
          提交申请
        </button>
      </div>
    </form>
    
    <!-- 成功消息 -->
    <div id="successMessage" class="hidden mt-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded dark:bg-green-900/30 dark:border-green-400 dark:text-green-300 transition-colors">
      <p>友链申请已提交！我会尽快审核并与您联系。</p>
    </div>
    
    <!-- 错误消息 -->
    <div id="errorMessage" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded dark:bg-red-900/30 dark:border-red-400 dark:text-red-300 transition-colors">
      <p>提交失败，请稍后重试。</p>
    </div>
  </div>
  
  <script>
    // 极验验证对象
    let captchaObj: any = null;
    
    // 初始化极验验证
    function initGeetestCaptcha() {
      // 引入极验脚本
      const script = document.createElement('script');
      script.src = 'https://static.geetest.com/v4/gt4.js';
      script.onload = function() {
        // 初始化极验
        (window as any).initGeetest4({
          captchaId: 'd6f0e6f2e4e1227768db4e09e9eeb21a',
          product: 'popup',
          language: 'zho'
        }, function (captcha: any) {
          captchaObj = captcha;
          // 将验证按钮添加到容器中
          captchaObj.appendTo("#captcha-container");
        });
      };
      document.head.appendChild(script);
    }
    
    // 获取友链数据并渲染
    async function loadFriends() {
      try {
        // 首先尝试使用主接口
        let response = await fetch('https://yl.baili.cfd/friends.json');
        if (!response.ok) throw new Error('主接口请求失败');
        
        let friends: any[] = await response.json();
        renderFriends(friends);
      } catch (primaryError) {
        console.error('主接口加载失败:', primaryError);
        try {
          // 如果主接口失败，尝试使用备用接口
          const response = await fetch('https://blog.my0811.cn/friends.json');
          if (!response.ok) throw new Error('备用接口请求失败');
          
          const friends: any[] = await response.json();
          renderFriends(friends);
        } catch (secondaryError) {
          console.error('备用接口加载失败:', secondaryError);
          const container = document.getElementById('friends-container');
          if (container) {
            container.innerHTML = '<div class="col-span-full text-center py-10 text-red-500">加载失败，请检查网络连接</div>';
          }
        }
      }
    }
    
    // 渲染友链
    function renderFriends(friends: any[]) {
      const container = document.getElementById('friends-container');
      
      if (!container) return;
      
      if (friends.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center py-10">暂无友链</div>';
        return;
      }
      
      let html = '';
      friends.forEach((friend: any) => {
        // 处理API返回的数据格式，确保字段名匹配
        const name = friend.name || '';
        const url = friend.url || '#';
        const avatar = friend.avatar || '';
        const description = friend.description || '';
        
        html += `
          <div class="card-base p-5 flex flex-col hover:opacity-80 transition-opacity duration-300 h-full">
            <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
              ${avatar ? `
                <img 
                  src="${avatar}" 
                  alt="${name}" 
                  class="w-16 h-16 rounded-full object-cover border-2 border-gray-200 dark:border-gray-600 flex-shrink-0"
                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgZmlsbD0iI2NjYyI+PGNpcmNsZSBjeD0iOCIgY3k9IjgiIHI9IjgiLz48L3N2Zz4='"
                />
              ` : `
                <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center dark:bg-gray-700 flex-shrink-0">
                  <i class="fa-solid fa-user text-gray-500 dark:text-gray-400"></i>
                </div>
              `}
              <div class="flex-1 min-w-0 text-center sm:text-left">
                <h3 class="font-bold text-lg truncate dark:text-white">${name}</h3>
                ${description ? `<p class="text-sm text-gray-500 line-clamp-2 mt-1 dark:text-gray-400 text-center sm:text-left">${description}</p>` : ''}
              </div>
            </div>
            <div class="mt-auto flex justify-center sm:justify-end">
              <a 
                href="${url}" 
                target="_blank" 
                rel="noopener noreferrer"
                class="btn-regular rounded-md px-4 py-2 flex items-center gap-2 dark:text-white"
                title="访问网站"
              >
                <span>访问网站</span>
                <i class="fa-solid fa-arrow-up-right-from-square"></i>
              </a>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // 表单提交处理
    const friendForm = document.getElementById('friendForm');
    if (friendForm) {
      friendForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const form = document.getElementById('friendForm') as HTMLFormElement | null;
        if (!form) return;
        
        // 隐藏之前的错误消息
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
          errorMessage.classList.add('hidden');
        }
        
        // 获取表单数据
        const formData = new FormData(form);
        const data = {
          siteName: formData.get('siteName') as string || '',
          siteUrl: formData.get('siteUrl') as string || '',
          siteDescription: formData.get('siteDescription') as string || '',
          siteAvatar: formData.get('siteAvatar') as string || '',
          email: formData.get('email') as string || ''
        };
        
        // 验证必需字段
        if (!data.siteName || !data.siteUrl || !data.email) {
          if (errorMessage) {
            errorMessage.classList.remove('hidden');
            errorMessage.innerHTML = '<p>网站名称、链接和邮箱为必填项</p>';
            setTimeout(() => {
              if (errorMessage) {
                errorMessage.classList.add('hidden');
              }
            }, 3000);
          }
          return;
        }
        
        // 验证URL格式
        try {
          new URL(data.siteUrl);
        } catch (e) {
          if (errorMessage) {
            errorMessage.classList.remove('hidden');
            errorMessage.innerHTML = '<p>网站链接格式不正确</p>';
            setTimeout(() => {
              if (errorMessage) {
                errorMessage.classList.add('hidden');
              }
            }, 3000);
          }
          return;
        }
        
        // 检查极验验证是否完成
        if (!captchaObj) {
          if (errorMessage) {
            errorMessage.classList.remove('hidden');
            errorMessage.innerHTML = '<p>验证加载失败，请刷新页面重试</p>';
            setTimeout(() => {
              if (errorMessage) {
                errorMessage.classList.add('hidden');
              }
            }, 3000);
          }
          return;
        }
        
        // 获取验证结果
        const validateResult = captchaObj.getValidate();
        if (!validateResult || !validateResult.lot_number) {
          if (errorMessage) {
            errorMessage.classList.remove('hidden');
            errorMessage.innerHTML = '<p>请先完成人机验证</p>';
            setTimeout(() => {
              if (errorMessage) {
                errorMessage.classList.add('hidden');
              }
            }, 3000);
          }
          return;
        }
        
        try {
          // 使用 API 文档中的接口提交友链申请，同时传递验证信息
          const response = await fetch('https://yl.baili.cfd/api/friends_api.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              siteName: data.siteName,
              siteUrl: data.siteUrl,
              siteDescription: data.siteDescription || '',
              siteAvatar: data.siteAvatar || '',
              email: data.email,
              geetestData: validateResult // 将极验验证数据一并发送
            })
          });
          
          const result = await response.json();
          
          // 显示成功或错误消息
          const successMessage = document.getElementById('successMessage');
          if (result.success) {
            // 显示成功消息
            if (successMessage) {
              successMessage.classList.remove('hidden');
            }
            // 清空表单
            form.reset();
            // 重置验证
            captchaObj.reset();
            // 3秒后隐藏消息
            setTimeout(() => {
              if (successMessage) {
                successMessage.classList.add('hidden');
              }
            }, 3000);
          } else {
            // 显示错误消息
            if (errorMessage) {
              errorMessage.classList.remove('hidden');
              errorMessage.innerHTML = `<p>${result.message || '提交失败，请稍后重试'}</p>`;
              setTimeout(() => {
                if (errorMessage) {
                  errorMessage.classList.add('hidden');
                }
              }, 3000);
            }
            // 重置验证
            captchaObj.reset();
          }
        } catch (error) {
          console.error('提交失败:', error);
          // 显示错误消息
          if (errorMessage) {
            errorMessage.classList.remove('hidden');
            errorMessage.innerHTML = '<p>网络错误，请稍后重试</p>';
            setTimeout(() => {
              if (errorMessage) {
                errorMessage.classList.add('hidden');
              }
            }, 3000);
          }
          // 重置验证
          captchaObj.reset();
        }
      });
    }
    
    // 页面加载时获取友链数据并初始化极验验证
    loadFriends();
    initGeetestCaptcha();
  </script>
  
  </MainGridLayout>